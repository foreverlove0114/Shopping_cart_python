pipeline {
    agent any

    parameters {
        choice(
            name: 'BASE_URL',
            choices: ['http://localhost:5000', 'http://staging.example.com', 'http://prod.example.com'],
            description: 'Target environment for Python tests'
        )
        string(
            name: 'PYTEST_TIMEOUT',
            defaultValue: '30',
            description: 'Pytest timeout in seconds'
        )
        booleanParam(
            name: 'RUN_E2E_TESTS',
            defaultValue: false,  // é»˜è®¤ç¦ç”¨E2Eæµ‹è¯•
            description: 'Run end-to-end Selenium tests'
        )
    }

    environment {
        BASE_URL = "${params.BASE_URL}"
        PYTEST_TIMEOUT = "${params.PYTEST_TIMEOUT}"
        RUN_E2E_TESTS = "${params.RUN_E2E_TESTS}"
        // æ·»åŠ æ—¶é—´æˆ³ç¯å¢ƒå˜é‡
        BUILD_TIMESTAMP = sh(script: 'date +"%Y-%m-%d %H:%M:%S"', returnStdout: true).trim()
    }

    triggers {
        // ä»£ç æ¨é€è‡ªåŠ¨è§¦å‘
        pollSCM('H/5 * * * *')  // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ä»£ç å˜æ›´
        // æˆ–è€…ä½¿ç”¨webhookè§¦å‘ï¼ˆéœ€è¦åœ¨Jenkinsä¸­é…ç½®GitHub webhookï¼‰
        // githubPush()
    }

    options {
        timeout(time: 10, unit: 'MINUTES')  // æ„å»ºè¶…æ—¶è®¾ç½®
        timestamps()  // ä¸ºæ‰€æœ‰æ§åˆ¶å°è¾“å‡ºæ·»åŠ æ—¶é—´æˆ³
        buildDiscarder(logRotator(numToKeepStr: '10'))  // ä¿ç•™æœ€è¿‘10ä¸ªæ„å»º
    }

    stages {
        stage('Checkout') {
            steps {
                timestamps {  // ä¸ºè¿™ä¸ªé˜¶æ®µæ·»åŠ æ—¶é—´æˆ³
                    git branch: 'master',
                        url: 'https://github.com/foreverlove0114/Shopping_cart_python.git'
                    echo "âœ… ä»£ç æ£€å‡ºå®Œæˆ - ${env.BUILD_TIMESTAMP}"
                }
            }
        }

        stage('Verify Python') {
            steps {
                timestamps {
                    bat 'python --version'
                    bat 'pip --version'
                    echo "ğŸ Pythonç¯å¢ƒéªŒè¯å®Œæˆ"
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                timestamps {
                    script {
                        echo "ğŸ“¦ å®‰è£…Pythonä¾èµ–åŒ…..."

                        bat '''
                            echo å®‰è£…Flaskå’Œæµ‹è¯•ä¾èµ–...
                            pip install Flask Werkzeug pytest pytest-html pytest-timeout requests beautifulsoup4 selenium webdriver-manager python-dotenv

                            echo æ£€æŸ¥requirement.txt...
                            if exist requirement.txt (
                                echo æ‰¾åˆ°requirement.txtï¼Œå®‰è£…é¢å¤–ä¾èµ–...
                                pip install -r requirement.txt || echo "æœ‰äº›åŒ…å®‰è£…å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
                            ) else (
                                echo æœªæ‰¾åˆ°requirement.txt
                            )
                        '''

                        // éªŒè¯å®‰è£…
                        bat 'pip list | findstr -e Flask -e pytest -e requests'
                        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
                    }
                }
            }
        }

        stage('API Tests') {
            steps {
                timestamps {
                    script {
                        echo "ğŸ”Œ å¼€å§‹APIæµ‹è¯•..."
                        echo "ğŸ¯ æµ‹è¯•ç¯å¢ƒ: ${BASE_URL}"
                        echo "â±ï¸  æµ‹è¯•è¶…æ—¶: ${PYTEST_TIMEOUT}ç§’"

                        def startTime = System.currentTimeMillis()

                        bat """
                            python -m pytest Shopping-Cart-master/tests/ -v \
                            --html=api_test_report.html \
                            --self-contained-html \
                            --timeout=${PYTEST_TIMEOUT} \
                            --junitxml=api_test_results.xml
                        """

                        def endTime = System.currentTimeMillis()
                        def duration = (endTime - startTime) / 1000
                        echo "ğŸ“Š APIæµ‹è¯•æ‰§è¡Œæ—¶é—´: ${duration}ç§’"

                        // è®°å½•æµ‹è¯•æŒ‡æ ‡
                        currentBuild.description = "API Tests - ${duration}s"
                    }
                }
            }
            post {
                always {
                    // å‘å¸ƒæµ‹è¯•æŠ¥å‘Š
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: '.',
                        reportFiles: 'api_test_report.html',
                        reportName: 'Python API Test Report'
                    ])
                    // å‘å¸ƒJUnitæµ‹è¯•ç»“æœ
                    junit 'api_test_results.xml'
                }
            }
        }

        stage('Performance Metrics') {
            steps {
                timestamps {
                    script {
                        echo "ğŸ“ˆ æ”¶é›†æ€§èƒ½æŒ‡æ ‡..."

                        // è¯»å–æµ‹è¯•ç»“æœæ–‡ä»¶è·å–æµ‹è¯•æ•°é‡
                        def testResults = readFile('api_test_results.xml')
                        def testCount = testResults.split('tests=')[1].split('"')[1]
                        def failures = testResults.split('failures=')[1].split('"')[1]
                        def skipped = testResults.split('skipped=')[1].split('"')[1]

                        echo "ğŸ“Š æµ‹è¯•ç»Ÿè®¡:"
                        echo "   - æ€»æµ‹è¯•æ•°: ${testCount}"
                        echo "   - å¤±è´¥æ•°: ${failures}"
                        echo "   - è·³è¿‡æ•°: ${skipped}"
                        echo "   - é€šè¿‡ç‡: ${((testCount.toInteger() - failures.toInteger() - skipped.toInteger()) / testCount.toInteger() * 100).round(2)}%"

                        // è®°å½•åˆ°æ„å»ºæè¿°
                        currentBuild.description = "Tests: ${testCount} | Failures: ${failures} | Skipped: ${skipped}"
                    }
                }
            }
        }
    }

    post {
        always {
            timestamps {
                script {
                    def currentTime = new Date().format("yyyy-MM-dd HH:mm:ss")
                    echo "ğŸ æµæ°´çº¿æ‰§è¡Œå®Œæˆ - ${currentTime}"

                    // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                    bat '''
                        del /q test_files.txt 2>nul || echo "æ— éœ€æ¸…ç†"
                        del /q e2e_files.txt 2>nul || echo "æ— éœ€æ¸…ç†"
                    '''
                }
            }
        }
        success {
            timestamps {
                script {
                    def duration = (currentBuild.duration / 1000 / 60).round(2)
                    echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ€»è€—æ—¶: ${duration}åˆ†é’Ÿ"

                    // å‘é€æˆåŠŸé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
                    emailext (
                        subject: "âœ… SUCCESS: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
                        body: """
                        <h2>æ„å»ºæˆåŠŸ</h2>
                        <p><b>é¡¹ç›®:</b> ${env.JOB_NAME}</p>
                        <p><b>æ„å»ºå·:</b> ${env.BUILD_NUMBER}</p>
                        <p><b>è€—æ—¶:</b> ${currentBuild.durationString}</p>
                        <p><b>æµ‹è¯•ç¯å¢ƒ:</b> ${BASE_URL}</p>
                        <p><b>ä»£ç æäº¤:</b> ${env.GIT_COMMIT}</p>
                        <p><a href="${env.BUILD_URL}">æŸ¥çœ‹æ„å»ºè¯¦æƒ…</a></p>
                        """,
                        to: "developer@example.com"
                    )
                }
            }
        }
        failure {
            timestamps {
                echo "âŒ æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æŠ¥å‘Š"

                // å‘é€å¤±è´¥é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
                emailext (
                    subject: "âŒ FAILURE: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
                    body: """
                    <h2>æ„å»ºå¤±è´¥</h2>
                    <p><b>é¡¹ç›®:</b> ${env.JOB_NAME}</p>
                    <p><b>æ„å»ºå·:</b> ${env.BUILD_NUMBER}</p>
                    <p><b>å¤±è´¥é˜¶æ®µ:</b> ${currentBuild.result}</p>
                    <p><b>æµ‹è¯•ç¯å¢ƒ:</b> ${BASE_URL}</p>
                    <p><a href="${env.BUILD_URL}">æŸ¥çœ‹æ„å»ºè¯¦æƒ…</a></p>
                    """,
                    to: "developer@example.com"
                )
            }
        }
        unstable {
            timestamps {
                echo "âš ï¸  æµ‹è¯•ä¸ç¨³å®šï¼Œæœ‰æµ‹è¯•ç”¨ä¾‹å¤±è´¥"
            }
        }
        changed {
            timestamps {
                script {
                    if (currentBuild.previousBuild != null) {
                        if (currentBuild.result != currentBuild.previousBuild.result) {
                            echo "ğŸ“Š æ„å»ºçŠ¶æ€å˜åŒ–: ${currentBuild.previousBuild.result} â†’ ${currentBuild.result}"
                        }
                    }
                }
            }
        }
    }
}