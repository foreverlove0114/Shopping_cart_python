pipeline {
    agent any

    parameters {
        choice(
            name: 'BASE_URL',
            choices: ['http://localhost:5000/', 'http://staging.example.com/', 'http://prod.example.com/'],
            description: 'Target environment for Python tests'
        )
        string(
            name: 'PYTEST_TIMEOUT',
            defaultValue: '30',
            description: 'Pytest timeout in seconds'
        )
        booleanParam(
            name: 'RUN_E2E_TESTS',
            defaultValue: true,
            description: 'Run end-to-end Selenium tests'
        )
    }

    tools {
        python 'Python39'  // éœ€è¦åœ¨Jenkinsä¸­é…ç½®
    }

    environment {
        BASE_URL = "${params.BASE_URL}"
        PYTEST_TIMEOUT = "${params.PYTEST_TIMEOUT}"
        RUN_E2E_TESTS = "${params.RUN_E2E_TESTS}"
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/foreverlove0114/Shopping_cart_python.git'
                script {
                    echo "âœ… ä»£ç æ£€å‡ºå®Œæˆ"
                    echo "ğŸ“ å·¥ä½œç›®å½•: ${env.WORKSPACE}"
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                script {
                    echo "ğŸ å®‰è£…Pythonä¾èµ–..."
                    bat "pip install -r requirements.txt pytest pytest-html requests beautifulsoup4 selenium"

                    // æ£€æŸ¥å®‰è£…ç»“æœ
                    bat "python --version"
                    bat "pytest --version"
                }
            }
        }

        stage('Run API Tests') {
            steps {
                script {
                    echo "ğŸ”Œ å¼€å§‹APIæµ‹è¯•..."
                    echo "ğŸ¯ æµ‹è¯•ç¯å¢ƒ: ${BASE_URL}"

                    bat """
                        python -m pytest test_routes/ -v \
                        --html=api_test_report.html \
                        --self-contained-html \
                        --timeout=${PYTEST_TIMEOUT} \
                        -o log_cli=true
                    """
                }
            }
            post {
                always {
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: '.',
                        reportFiles: 'api_test_report.html',
                        reportName: 'Python API Test Report'
                    ])
                }
            }
        }

        stage('Run E2E Tests') {
            when {
                expression { return env.RUN_E2E_TESTS == 'true' }
            }
            steps {
                script {
                    echo "ğŸ¨ å¼€å§‹E2Eæµ‹è¯•..."
                    echo "ğŸ¯ æµ‹è¯•ç¯å¢ƒ: ${BASE_URL}"

                    // è®¾ç½®ç¯å¢ƒå˜é‡ä¾›E2Eæµ‹è¯•ä½¿ç”¨
                    bat """
                        set BASE_URL=${BASE_URL}
                        python -m pytest Pages/end_to_end.py -v \
                        --html=e2e_test_report.html \
                        --self-contained-html \
                        --timeout=60 \
                        -o log_cli=true
                    """
                }
            }
            post {
                always {
                    publishHTML([
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: '.',
                        reportFiles: 'e2e_test_report.html',
                        reportName: 'Python E2E Test Report'
                    ])
                }
            }
        }

        stage('Test Summary') {
            steps {
                script {
                    echo "ğŸ“Š æµ‹è¯•æ‰§è¡Œå®Œæˆ"
                    echo "ğŸŒ æµ‹è¯•ç¯å¢ƒ: ${BASE_URL}"
                    echo "â±ï¸  APIè¶…æ—¶: ${PYTEST_TIMEOUT}ç§’"
                    echo "ğŸ¨  E2Eæµ‹è¯•: ${RUN_E2E_TESTS}"
                    echo "ğŸ“ å·¥ä½œç©ºé—´: ${env.WORKSPACE}"
                }
            }
        }
    }

    post {
        always {
            script {
                echo "ğŸ Pythonæµ‹è¯•æµæ°´çº¿æ‰§è¡Œå®Œæˆ"
                // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                bat "del /q *.log || echo No log files to delete"
            }
        }
        success {
            script {
                echo "ğŸ‰ æ‰€æœ‰Pythonæµ‹è¯•é€šè¿‡ï¼"
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€šçŸ¥ï¼Œæ¯”å¦‚é‚®ä»¶ã€Slackç­‰
            }
        }
        failure {
            script {
                echo "âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æŠ¥å‘Š"
                // å¤±è´¥é€šçŸ¥
            }
        }
        unstable {
            script {
                echo "âš ï¸ æµ‹è¯•ç»“æœä¸ç¨³å®šï¼Œå¯èƒ½æœ‰é—ªçƒæµ‹è¯•"
            }
        }
    }
}