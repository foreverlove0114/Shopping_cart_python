// Jenkinsfile (在GitHub仓库根目录创建此文件)
pipeline {
    agent any
    
    environment {
        APP_URL = 'http://localhost:5000'
        BASE_URL = 'http://localhost:5000'
    }
    
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', 
                url: 'https://github.com/foreverlove0114/Shopping_cart_python.git'
            }
        }
        
        stage('Setup Environment') {
            steps {
                bat '''
                    python -m venv venv
                    call venv\\Scripts\\activate.bat
                    pip install -r requirements.txt
                    pip install pytest selenium requests beautifulsoup4
                '''
            }
        }
        
        stage('Run API Tests') {
            steps {
                script {
                    try {
                        bat '''
                            call venv\\Scripts\\activate.bat
                            pytest test_auth_routes.py test_cart_routes.py -v --junitxml=api-test-results.xml
                        '''
                    } catch (e) {
                        echo "API Tests failed: ${e}"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
            post {
                always {
                    junit 'api-test-results.xml'
                }
            }
        }
        
        stage('Run E2E Tests') {
            steps {
                script {
                    // 启动测试服务器 - Windows版本
                    bat '''
                        call venv\\Scripts\\activate.bat
                        start /B python app.py > server.log 2>&1
                        echo %ERRORLEVEL% > server.pid
                        timeout /t 10 /nobreak
                    '''
                    
                    try {
                        bat '''
                            call venv\\Scripts\\activate.bat
                            pytest TestECommerceE2E.py -v --junitxml=e2e-test-results.xml
                        '''
                    } catch (e) {
                        echo "E2E Tests failed: ${e}"
                        currentBuild.result = 'UNSTABLE'
                    }
                    
                    // 停止服务器 - Windows版本
                    bat '''
                        for /f "tokens=1" %%i in (server.pid) do taskkill /pid %%i /f || echo "Process not found"
                        del server.pid
                    '''
                }
            }
            post {
                always {
                    junit 'e2e-test-results.xml'
                    archiveArtifacts 'server.log'
                }
            }
        }
        
        stage('Publish Reports') {
            steps {
                publishHTML target: [
                    allowMissing: false,
                    alwaysLinkToLastBuild: false,
                    keepAll: true,
                    reportDir: '.',
                    reportFiles: '**/*.html',
                    reportName: 'HTML Report'
                ]
            }
        }
    }
    
    post {
        always {
            cleanWs()
            echo "Pipeline completed: ${currentBuild.result}"
        }
        success {
            echo 'All tests passed! ✅'
        }
        failure {
            echo 'Pipeline failed! ❌'
        }
        unstable {
            echo 'Some tests failed! ⚠️'
        }
    }
}
